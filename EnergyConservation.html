<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能量守恒 / Energy Conservation - Wuli布雷克</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+SC:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #FFF9F0;
            --primary: #FF8c42;
            --secondary: #FFC75F;
            --accent: #FF5E5B;
            --text-dark: #4A403A;
            --card-bg: #FFFFFF;
            --shadow: 0 6px 30px rgba(255, 140, 66, 0.18);
            --radius: 30px;
            --pe-color: #2ecc71;
            /* Potential Energy */
            --ke-color: #3498db;
            /* Kinetic Energy */
            --total-color: #9b59b6;
            /* Total Energy */
            --th-color: #e67e22;
            /* Thermal Energy */
            --v-color: #f1c40f;
            /* Velocity */
            --h-color: #16a085;
            /* Height */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Fredoka', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 15px 40px;
        }

        .branding {
            position: fixed;
            top: 25px;
            left: 30px;
            z-index: 1000;
        }

        .logo {
            font-weight: 700;
            font-size: 1.6rem;
            color: #FFFFFF;
            background: var(--primary);
            padding: 10px 25px;
            border-radius: 20px;
            box-shadow: 4px 4px 15px rgba(255, 140, 66, 0.3);
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin-top: 15px;
            display: grid;
            grid-template-areas:
                "header header"
                "formula formula"
                "diagram controls";
            grid-template-columns: 1fr 450px;
            gap: 20px;
        }

        header {
            grid-area: header;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .subtitle-text {
            font-size: 1.25rem;
            color: #666;
            line-height: 1.4;
        }

        /* Formula Section */
        .formula-display {
            grid-area: formula;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid #fff5eb;
        }

        .formula-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            height: 80px;
        }

        .result-row {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            border-top: 1px solid #eee;
            padding-top: 10px;
            width: 100%;
        }

        .legend-item {
            font-size: 1rem;
            font-weight: 600;
        }

        .sym-key {
            font-weight: 700;
            margin-right: 5px;
        }

        .formula-unit {
            font-size: 0.7em;
            margin-left: 2px;
            opacity: 0.8;
        }

        /* Diagram Section */
        .diagram-section {
            grid-area: diagram;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            min-height: 480px;
            display: flex;
            flex-direction: column;
        }

        canvas {
            width: 100%;
            flex: 1;
            display: block;
        }

        /* Controls Section */
        .controls-section {
            grid-area: controls;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            font-size: 1.15rem;
        }

        .val-badge {
            background: #fff;
            padding: 3px 10px;
            border-radius: 8px;
            font-size: 1.1rem;
            border: 2px solid #f0f0f0;
        }

        /* Dropdown & Sliders */
        select {
            width: 100%;
            padding: 8px;
            border-radius: 10px;
            border: 2px solid #eee;
            font-family: inherit;
            font-size: 1.1rem;
            outline: none;
            cursor: pointer;
            background: #fff;
        }

        input[type=range] {
            width: 100%;
            appearance: none;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            outline: none;
        }

        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            background: var(--primary);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        #m-slider::-webkit-slider-thumb {
            background: var(--total-color);
        }

        #h-slider::-webkit-slider-thumb {
            background: var(--pe-color);
        }

        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 5px;
        }

        .ctrl-btn {
            padding: 12px;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .start {
            background-color: var(--primary);
        }

        .pause {
            background-color: #2ecc71;
        }

        .reset {
            background-color: #95a5a6;
        }

        .ctrl-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* Energy Bar Area */
        .stats-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .bar-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .bar-label {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .bar-bg {
            background: #f0f0f0;
            height: 18px;
            border-radius: 9px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            border-radius: 9px;
            transition: width 0.05s linear;
        }

        @media (max-width: 1100px) {
            .container {
                grid-template-areas: "header" "formula" "diagram" "controls";
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="branding">
        <div class="logo">Wuli布雷克</div>
    </div>

    <div class="container">
        <header>
            <h1>能量守恒 / Energy Conservation</h1>
            <p class="subtitle-text">
                Energy can neither be created nor destroyed; only transformed.<br>
                能量既不会凭空产生，也不会凭空消失，只能从一种形式转化为另一种形式。
            </p>
        </header>

        <!-- Formula Section -->
        <section class="formula-display">
            <div class="formula-container" id="formula-root">
                <!-- Symbols rendered via JS -->
            </div>
            <div class="result-row">
                <span id="res-E" style="color:var(--total-color)">0</span> J =
                <span id="res-Ep" style="color:var(--pe-color)">0</span> J +
                <span id="res-Ek" style="color:var(--ke-color)">0</span> J +
                <span id="res-Eth" style="color:var(--th-color)">0</span> J
            </div>
            <div class="legend">
                <div class="legend-item"><span class="sym-key" style="color:var(--total-color)">E</span>: Total (总能)
                </div>
                <div class="legend-item"><span class="sym-key" style="color:var(--pe-color)">E<sub>p</sub></span>:
                    Potential (势能)</div>
                <div class="legend-item"><span class="sym-key" style="color:var(--ke-color)">E<sub>k</sub></span>:
                    Kinetic (动能)</div>
                <div class="legend-item"><span class="sym-key" style="color:var(--th-color)">E<sub>th</sub></span>:
                    Thermal (内能)</div>
            </div>
        </section>

        <!-- Diagram Section -->
        <section class="diagram-section">
            <canvas id="simCanvas"></canvas>
        </section>

        <!-- Controls Section -->
        <section class="controls-section">
            <div class="control-panel">
                <div class="control-group">
                    <div class="label-row">
                        <span>Mass (质量 m)</span>
                        <span id="m-badge" class="val-badge">10 kg</span>
                    </div>
                    <input type="range" id="m-slider" min="1" max="100" value="10">
                </div>

                <div class="control-group">
                    <div class="label-row">
                        <span>Initial Height (起始高度 h₀)</span>
                        <span id="h-badge" class="val-badge">8.0 m</span>
                    </div>
                    <input type="range" id="h-slider" min="2" max="12" step="0.1" value="8.0">
                </div>

                <div class="control-group">
                    <div class="label-row">
                        <span>Friction Coefficient (摩擦系数 µ)</span>
                        <span id="f-badge" class="val-badge">None</span>
                    </div>
                    <input type="range" id="f-slider" min="0" max="3" step="1" value="0">
                </div>

                <div class="btn-row">
                    <button id="btn-start" class="ctrl-btn pause">暂停 Pause</button>
                    <button id="btn-reset" class="ctrl-btn reset">重置 Reset</button>
                </div>
            </div>

            <div class="stats-panel">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="bar-container">
                        <div class="bar-label"><span>Potential Eₚ (势能)</span></div>
                        <div class="bar-bg">
                            <div id="bar-pe" class="bar-fill" style="background: var(--pe-color); width: 0%;"></div>
                        </div>
                        <div style="text-align: right; font-weight: 600;" id="val-pe">0 J</div>
                    </div>
                    <div class="bar-container">
                        <div class="bar-label"><span>Kinetic Eₖ (动能)</span></div>
                        <div class="bar-bg">
                            <div id="bar-ke" class="bar-fill" style="background: var(--ke-color); width: 0%;"></div>
                        </div>
                        <div style="text-align: right; font-weight: 600;" id="val-ke">0 J</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="bar-container">
                        <div class="bar-label"><span>Height h (高度)</span></div>
                        <div class="bar-bg">
                            <div id="bar-h" class="bar-fill" style="background: var(--h-color); width: 0%;"></div>
                        </div>
                        <div style="text-align: right; font-weight: 600;" id="val-h">0 m</div>
                    </div>
                    <div class="bar-container">
                        <div class="bar-label"><span>Velocity v (速度)</span></div>
                        <div class="bar-bg">
                            <div id="bar-v" class="bar-fill" style="background: var(--v-color); width: 0%;"></div>
                        </div>
                        <div style="text-align: right; font-weight: 600;" id="val-v">0 m/s</div>
                    </div>
                </div>

                <div class="bar-container" style="margin-top: 5px; border-top: 1px dashed #ddd; padding-top: 10px;">
                    <div class="bar-label">
                        <span style="color: var(--th-color)">Thermal Eₜₕ (内能)</span>
                        <span style="color: var(--total-color)">Total E (总能)</span>
                    </div>
                    <div class="bar-bg" style="display: flex; background: #f0f0f0;">
                        <div id="bar-mech" class="bar-fill"
                            style="background: var(--total-color); width: 100%; border-radius: 9px 0 0 9px;"></div>
                        <div id="bar-th" class="bar-fill"
                            style="background: var(--th-color); width: 0%; border-radius: 0 9px 9px 0;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: 700; margin-top: 5px;">
                        <span id="val-th" style="color: var(--th-color)">0 J</span>
                        <span id="val-total" style="color: var(--total-color)">0 J</span>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas'), ctx = canvas.getContext('2d');
        const sM = document.getElementById('m-slider'), sH0 = document.getElementById('h-slider'), sF = document.getElementById('f-slider');
        const bM = document.getElementById('m-badge'), bH0 = document.getElementById('h-badge'), bF = document.getElementById('f-badge');
        const resE = document.getElementById('res-E'), resEp = document.getElementById('res-Ep'), resEk = document.getElementById('res-Ek'), resEth = document.getElementById('res-Eth');
        const barPE = document.getElementById('bar-pe'), barKE = document.getElementById('bar-ke'), barMech = document.getElementById('bar-mech'), barTH = document.getElementById('bar-th');
        const barH = document.getElementById('bar-h'), barV = document.getElementById('bar-v');
        const valPE = document.getElementById('val-pe'), valKE = document.getElementById('val-ke'), valTotal = document.getElementById('val-total'), valTH = document.getElementById('val-th');
        const valH = document.getElementById('val-h'), valV = document.getElementById('val-v');
        const bStart = document.getElementById('btn-start'), bReset = document.getElementById('btn-reset');
        const formulaRoot = document.getElementById('formula-root');

        const state = {
            m: 10, h0: 8, g: 9.81, f: 0,
            time: 0, isPlaying: true,
            normX: 1, velX: 0,
            currentH: 8, currentV: 0,
            thermalE: 0, totalE: 0,
            trackW: 0, trackH: 0
        };

        function resize() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            state.trackW = canvas.width * 0.8;
            state.trackH = canvas.height * 0.7;
        }
        window.addEventListener('resize', resize);

        // U-Track Parabola: y = k * (x - offset)^2
        // We normalize x from -1 to 1.
        function getTrackH(normX) {
            return normX * normX * state.h0;
        }

        function update() {
            state.m = parseFloat(sM.value);
            state.h0 = parseFloat(sH0.value);

            // Map friction levels
            const fLevels = [0, 0.02, 0.05, 0.1];
            const fLabels = ["None", "Low 低", "Medium 中", "High 高"];
            const fIndex = parseInt(sF.value);
            state.f = fLevels[fIndex];

            bM.textContent = state.m + ' kg';
            bH0.textContent = state.h0.toFixed(1) + ' m';
            bF.textContent = fLabels[fIndex];

            if (state.totalE === 0) state.totalE = state.m * state.g * state.h0;

            if (state.isPlaying) {
                // Real 2nd order kinetics on parabola y = a x^2
                // Force = -mg * sin(theta) - friction
                // On y = h0 * x^2, slope dy/dx = 2 * h0 * x
                const L = 10;
                const slope = (2 * state.h0 * state.normX) / L;
                const accX = -state.g * slope / 3000; // Even more ultra slow

                state.velX += accX;

                // Dissipative Friction
                if (state.f > 0) {
                    const movement = Math.abs(state.velX);
                    // Work done by friction: W = f * m * g * distance
                    // Since it's a simulation, we scale the loss for visibility
                    const workScale = 15;
                    const energyLoss = state.f * state.m * state.g * movement * workScale;

                    state.thermalE = Math.min(state.totalE, state.thermalE + energyLoss);

                    // Apply velocity damping consistent with energy loss
                    const mechE = state.totalE - state.thermalE;
                    if (mechE <= 0.5) { // Threshold for stopping
                        state.thermalE = state.totalE;
                        state.velX = 0;
                        state.normX *= 0.9; // Gently pull to center
                        if (Math.abs(state.normX) < 0.01) state.normX = 0;
                    } else {
                        // Damping factor to slow down velocity as energy is lost
                        state.velX *= 0.995;
                    }
                }

                state.normX += state.velX;

                // Bounds
                if (Math.abs(state.normX) > 1.25) {
                    state.normX = state.normX > 0 ? 1.25 : -1.25;
                    state.velX *= -0.5;
                }
            }

            state.currentH = getTrackH(Math.min(1.25, Math.max(-1.25, state.normX)));
            const currentMechE = Math.max(0, state.totalE - state.thermalE);

            // Re-partition remaining mechanical energy
            const pe = Math.min(currentMechE, state.m * state.g * state.currentH);
            const ke = Math.max(0, currentMechE - pe);
            state.currentV = Math.sqrt(2 * ke / state.m);

            updateUI(state.totalE, state.thermalE, pe, ke);
            draw();
            requestAnimationFrame(update);
        }

        function updateUI(totalE, thermalE, pe, ke) {
            const mechE = totalE - thermalE;
            resE.textContent = Math.round(totalE);
            resEp.textContent = Math.round(pe);
            resEk.textContent = Math.round(ke);
            resEth.textContent = Math.round(thermalE);

            barPE.style.width = totalE > 0 ? (pe / totalE) * 100 + '%' : '0%';
            barKE.style.width = totalE > 0 ? (ke / totalE) * 100 + '%' : '0%';

            const mechPer = totalE > 0 ? (mechE / totalE) * 100 : 0;
            barMech.style.width = mechPer + '%';
            barTH.style.width = (100 - mechPer) + '%';

            valPE.textContent = Math.round(pe) + ' J';
            valKE.textContent = Math.round(ke) + ' J';
            valTH.textContent = Math.round(thermalE) + ' J';
            valTotal.textContent = Math.round(totalE) + ' J';

            // Height & Velocity Bars
            barH.style.width = (state.currentH / 12) * 100 + '%';
            valH.textContent = state.currentH.toFixed(1) + ' m';

            const maxV = Math.sqrt(2 * (100 * 9.81 * 12) / 1); // rough max
            barV.style.width = Math.min(100, (state.currentV / 15) * 100) + '%'; // 15m/s as 100%
            valV.textContent = state.currentV.toFixed(1) + ' m/s';

            // Formula Scaling
            const baseSize = 34;
            const maxRef = 100 * 9.81 * 12;
            const sPE = 0.8 + (pe / maxRef) * 0.5;
            const sKE = 0.8 + (ke / maxRef) * 0.5;
            const sTH = 0.8 + (thermalE / maxRef) * 0.5;

            const html = `
                <span style="color:var(--total-color); font-weight:700; font-size:${baseSize}px">E</span>
                <span style="font-size:${baseSize}px; margin:0 5px">=</span>
                <span style="color:var(--pe-color); transition:all 0.1s; font-size:${baseSize * sPE}px">
                    E<sub>p</sub> <small style="font-size:0.6em">(mgh)</small>
                </span>
                <span style="font-size:${baseSize}px; margin:0 5px">+</span>
                <span style="color:var(--ke-color); transition:all 0.1s; font-size:${baseSize * sKE}px">
                    E<sub>k</sub> <small style="font-size:0.6em">(½mv²)</small>
                </span>
                <span style="font-size:${baseSize}px; margin:0 5px">+</span>
                <span style="color:var(--th-color); transition:all 0.1s; font-size:${baseSize * sTH}px">
                    E<sub>th</sub>
                </span>
            `;
            if (formulaRoot.innerHTML !== html) formulaRoot.innerHTML = html;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const margin = canvas.width * 0.1;
            const centerY = canvas.height * 0.15;
            const groundY = canvas.height * 0.85;
            const trackWidth = canvas.width * 0.8;
            const meterPx = (groundY - centerY) / 12; // 12m vertical range

            // Draw Track
            ctx.beginPath();
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            for (let i = -1; i <= 1; i += 0.02) {
                const tx = (canvas.width / 2) + i * (trackWidth / 2);
                const ty = groundY - getTrackH(i) * meterPx;
                if (i === -1) ctx.moveTo(tx, ty);
                else ctx.lineTo(tx, ty);
            }
            ctx.stroke();

            // Ground
            ctx.beginPath(); ctx.strokeStyle = '#eee'; ctx.lineWidth = 2;
            ctx.moveTo(0, groundY); ctx.lineTo(canvas.width, groundY); ctx.stroke();

            // Ball
            const bX = (canvas.width / 2) + state.normX * (trackWidth / 2);
            const bY = groundY - state.currentH * meterPx;
            const radius = (12 + (Math.log10(state.m) * 10)) * 1.33;

            // Ball Shadow (optional, let's keep it simple)
            ctx.beginPath(); ctx.ellipse(bX, groundY + 5, radius * 0.8, 5, 0, 0, Math.PI * 2); ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.fill();

            ctx.beginPath(); ctx.arc(bX, bY - radius, radius, 0, Math.PI * 2);
            const grad = ctx.createRadialGradient(bX - radius * 0.3, bY - radius * 1.3, radius * 0.1, bX, bY - radius, radius);
            grad.addColorStop(0, '#fff'); grad.addColorStop(0.2, varColor('--ke-color')); grad.addColorStop(1, '#000');
            ctx.fillStyle = grad; ctx.fill();
            ctx.beginPath(); ctx.arc(bX, bY - radius, radius, 0, Math.PI * 2); ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.lineWidth = 1; ctx.stroke();

            // Height measurement
            ctx.beginPath(); ctx.strokeStyle = varColor('--pe-color'); ctx.setLineDash([4, 4]);
            ctx.moveTo(bX, groundY); ctx.lineTo(bX, bY); ctx.stroke(); ctx.setLineDash([]);
            ctx.fillStyle = varColor('--pe-color'); ctx.font = 'bold 16px Fredoka'; ctx.textAlign = 'center';
            ctx.fillText('h = ' + state.currentH.toFixed(1) + 'm', bX, groundY + 25);
        }

        function varColor(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        bStart.onclick = () => {
            state.isPlaying = !state.isPlaying;
            bStart.textContent = state.isPlaying ? '暂停 Pause' : '开始 Start';
            bStart.classList.toggle('start', !state.isPlaying);
            bStart.classList.toggle('pause', state.isPlaying);
        };

        bReset.onclick = () => {
            state.time = 0;
            state.normX = 1;
            state.velX = 0;
            state.thermalE = 0;
            state.totalE = state.m * state.g * state.h0;
        };

        resize();
        update();
    </script>
</body>

</html>